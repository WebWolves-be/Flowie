<div
  class="bg-white shadow rounded-lg p-6"
  [class.mb-4]="!isLast()"
  [class.border-b]="!isLast()"
  [class.border-gray-200]="!isLast()">
  <div class="flex items-start justify-between">
    <div class="flex-1">
      <div class="flex items-center mb-3">
        <div
          class="progress-circle flex items-center justify-center w-9 h-9 rounded-lg text-xs font-bold mr-2.5"
          [ngClass]="progressClass()">
          <i class="fas" [ngClass]="statusIcon()"></i>
        </div>
        <h3 class="text-lg font-medium text-gray-900">{{ task().title }}</h3>
      </div>
      <p class="text-sm text-gray-500 mb-3">{{ task().description }}</p>
      @if (!task().subtasks || task().subtasks!.length === 0) {
        <div class="flex items-center text-sm text-black">
          <span>{{ task().taskTypeName }}</span>
          <span class="text-blue-600 font-bold mx-3">|</span>
          <span
            [class.text-red-600]="isTaskOverdue()"
            [class.font-semibold]="isTaskOverdue()">
            Deadline: {{ task().dueDate ? (task().dueDate | date:'d MMMM y':'':'nl-NL') : 'Geen deadline' }}
          </span>
          <span class="text-blue-600 font-bold mx-3">|</span>
          <span class="inline-flex items-center">
            {{ task().employeeName || 'Niet toegewezen' }}
          </span>
        </div>
      }
      @if (task().subtasks && task().subtasks!.length > 0) {
        <div class="mt-3">
          <h4 class="text-sm font-medium text-gray-700 mb-2">
            Subtaken ({{ taskProgress() }}% voltooid)
          </h4>
          <div class="space-y-3">
            @for (subtask of task().subtasks!; track $index) {
              <div
                class="px-3 py-2 rounded-r"
                [class.border-l-4]="true"
                [class.border-green-400]="isSubtaskDone(subtask)"
                [class.bg-green-50]="isSubtaskDone(subtask)"
                [class.border-gray-300]="!isSubtaskDone(subtask)"
                [class.bg-white]="!isSubtaskDone(subtask)">
                <div class="flex items-start justify-between">
                  <div class="flex-1">
                    <div class="flex items-center justify-between mb-1">
                      <span
                        class="text-sm font-medium"
                        [class.text-gray-500]="isSubtaskDone(subtask)"
                        [class.text-gray-900]="!isSubtaskDone(subtask)">
                        {{ subtask.title }}
                      </span>
                    </div>
                    @if (subtask.description) {
                      <p
                        class="text-xs text-gray-500 mb-3"
                        [class.text-gray-400]="isSubtaskDone(subtask)">
                        {{ subtask.description }}
                      </p>
                    }
                    <div class="flex items-center gap-2 text-xs mb-3">
                      <span class="text-gray-700">{{ subtask.taskTypeName }}</span>
                      <span class="text-blue-600 font-bold">|</span>
                      <span
                        class="font-medium"
                        [class.text-gray-600]="isSubtaskDone(subtask)"
                        [class.text-red-600]="!isSubtaskDone(subtask) && isSubtaskOverdue(subtask)"
                        [class.font-semibold]="!isSubtaskDone(subtask) && isSubtaskOverdue(subtask)"
                        [class.text-gray-600]="!isSubtaskDone(subtask) && !isSubtaskOverdue(subtask)"
                      >Deadline: {{ subtask.dueDate ? (subtask.dueDate | date:'d MMMM y':'':'nl-NL') : 'Geen deadline' }}</span>
                      <span class="text-blue-600 font-bold">|</span>
                      <span class="text-gray-700">{{ subtask.employeeName || 'Niet toegewezen' }}</span>
                    </div>
                    <div class="flex items-center gap-2">
                      @if (isSubtaskPending(subtask)) {
                        <button
                          (click)="onStartSubtask(subtask)"
                          class="border border-blue-600 text-blue-600 px-3 py-1 rounded text-sm bg-transparent hover:bg-blue-50">
                          Beginnen
                        </button>
                      }
                      @if (isSubtaskOngoing(subtask)) {
                        <button
                          (click)="onCompleteSubtask(subtask)"
                          class="border px-3 py-1 rounded text-sm bg-transparent"
                          style="border-color: #10B981; color: #10B981;"
                          onmouseover="this.style.backgroundColor='#D1FAE5'"
                          onmouseout="this.style.backgroundColor='transparent'">
                          Klaar
                        </button>
                      }
                      @if (isSubtaskDone(subtask)) {
                        <button
                          (click)="onReopenSubtask(subtask)"
                          class="border border-blue-600 text-blue-600 px-3 py-1 rounded text-sm bg-transparent hover:bg-blue-50">
                          Openzetten
                        </button>
                      }
                    </div>
                  </div>
                  @if (!isSubtaskDone(subtask)) {
                    <div class="relative ml-4">
                      <button
                        (click)="toggleSubtaskMenu($event, subtask.taskId)"
                        class="text-gray-400 hover:text-gray-600 p-2 rounded-full focus:outline-none"
                        title="Acties">
                        <i class="fas fa-ellipsis-vertical"></i>
                      </button>
                      @if (showSubtaskMenu() === subtask.taskId) {
                        <div
                          class="absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded shadow-lg z-20">
                          <button
                            (click)="onUpdateSubtask(subtask)"
                            class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                            <i class="fas fa-edit mr-2 w-4"></i>
                            Bewerken
                          </button>
                          @if (isSubtaskPending(subtask)) {
                            <button
                              (click)="onDeleteSubtask(subtask)"
                              class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100 flex items-center">
                              <i class="fas fa-trash mr-2 w-4"></i>
                              Verwijderen
                            </button>
                          }
                        </div>
                      }
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        </div>
      }
      @if (!task().subtasks || task().subtasks!.length === 0) {
        @if (isPending()) {
          <button
            (click)="onStartTask()"
            class="border border-blue-600 text-blue-600 px-3 py-1 rounded text-sm bg-transparent hover:bg-blue-50 mt-3">
            Beginnen
          </button>
        }
        @if (isOngoing()) {
          <button
            (click)="onCompleteTask()"
            class="border px-3 py-1 rounded text-sm bg-transparent mt-3"
            style="border-color: #10B981; color: #10B981;"
            onmouseover="this.style.backgroundColor='#D1FAE5'"
            onmouseout="this.style.backgroundColor='transparent'">
            Klaar
          </button>
        }
        @if (isDone()) {
          <button
            (click)="onReopenTask()"
            class="border border-blue-600 text-blue-600 px-3 py-1 rounded text-sm bg-transparent hover:bg-blue-50 mt-3">
            Openzetten
          </button>
        }
      }
    </div>

    @if (!isDone()) {
      <div class="ml-4 relative">
        <button
          (click)="toggleTaskMenu($event)"
          class="text-gray-400 hover:text-gray-600 p-2 rounded-full focus:outline-none"
          title="Acties">
          <i class="fas fa-ellipsis-vertical"></i>
        </button>
        @if (showMenu()) {
          <div class="absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded shadow-lg z-20">
            <button
              (click)="onCreateSubtask()"
              class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
              <i class="fas fa-plus mr-2 w-4"></i>
              Subtaak toevoegen
            </button>
            <button
              (click)="onUpdateTask()"
              class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
              <i class="fas fa-edit mr-2 w-4"></i>
              Bewerken
            </button>
            @if (isPending()) {
              <button
                (click)="onDeleteTask()"
                class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100 flex items-center">
                <i class="fas fa-trash mr-2 w-4"></i>
                Verwijderen
              </button>
            }
          </div>
        }
      </div>
    }
  </div>
</div>

