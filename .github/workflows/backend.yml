name: Deploy Backend

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/backend.yml'
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  build:
    name: Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore Flowie.sln

      - name: Build
        run: dotnet build Flowie.sln --configuration Release --no-restore

      - name: Run tests
        run: dotnet test Flowie.sln --configuration Release --no-build --verbosity normal


  deploy-testing:
    name: Deploy to Testing
    needs: [build]
    runs-on: ubuntu-latest
    environment:
      name: testing
      url: https://flowie-api-tst.graybush-4be8f739.westeurope.azurecontainerapps.io

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install EF Core tools
        run: dotnet tool install --global dotnet-ef --version 9.0.9 || dotnet tool update --global dotnet-ef --version 9.0.9

      - name: Restore dependencies
        run: dotnet restore backend/Flowie.Api/Flowie.Api.csproj

      - name: Build for migrations
        run: dotnet build backend/Flowie.Api/Flowie.Api.csproj --no-restore

      - name: Debug - Check DLL for migration types
        run: |
          echo "=== Checking if migration classes exist in compiled DLL ==="
          dotnet tool install --global dotnet-ildasm 2>/dev/null || true
          # List all files in bin directory
          ls -la backend/Flowie.Api/bin/Debug/net8.0/
          # Check if migration files were compiled by searching for the type names
          strings backend/Flowie.Api/bin/Debug/net8.0/Flowie.Api.dll | grep -i "Migration" | head -20 || echo "No migration strings found"

      - name: Debug - List migrations
        run: dotnet ef migrations list --project backend/Flowie.Api/Flowie.Api.csproj --no-build --no-connect --verbose

      - name: Run database migrations
        run: dotnet ef database update --project backend/Flowie.Api/Flowie.Api.csproj --connection "${{ secrets.AZURE_SQL_CONNECTION_STRING_TESTING }}" --no-build --verbose

      - name: Log in to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_LOGIN_SERVER_TESTING }}
          username: ${{ secrets.ACR_USERNAME_TESTING }}
          password: ${{ secrets.ACR_PASSWORD_TESTING }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Flowie.Api/Dockerfile
          push: true
          tags: |
            ${{ secrets.ACR_LOGIN_SERVER_TESTING }}/flowie-api:latest
            ${{ secrets.ACR_LOGIN_SERVER_TESTING }}/flowie-api:${{ github.sha }}

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Register Microsoft.App provider
        run: az provider register -n Microsoft.App --wait

      - name: Deploy to Azure Container Apps
        run: |
          az containerapp registry set \
            --name ${{ secrets.CONTAINER_APP_NAME_TESTING }} \
            --resource-group ${{ secrets.CONTAINER_APP_RESOURCE_GROUP_TESTING }} \
            --server ${{ secrets.ACR_LOGIN_SERVER_TESTING }} \
            --username ${{ secrets.ACR_USERNAME_TESTING }} \
            --password ${{ secrets.ACR_PASSWORD_TESTING }}

          az containerapp secret set \
            --name ${{ secrets.CONTAINER_APP_NAME_TESTING }} \
            --resource-group ${{ secrets.CONTAINER_APP_RESOURCE_GROUP_TESTING }} \
            --secrets \
              flowie-db-connection="${{ secrets.AZURE_SQL_CONNECTION_STRING_TESTING }}" \
              jwt-secret-key="${{ secrets.JWT_SECRET_KEY_TESTING }}" \
              registration-code="${{ secrets.REGISTRATION_CODE_TESTING }}"

          az containerapp update \
            --name ${{ secrets.CONTAINER_APP_NAME_TESTING }} \
            --resource-group ${{ secrets.CONTAINER_APP_RESOURCE_GROUP_TESTING }} \
            --image ${{ secrets.ACR_LOGIN_SERVER_TESTING }}/flowie-api:${{ github.sha }} \
            --set-env-vars \
              "ASPNETCORE_ENVIRONMENT=Testing" \
              "ConnectionStrings__FlowieDb=secretref:flowie-db-connection" \
              "JwtSettings__SecretKey=secretref:jwt-secret-key" \
              "Registration__Code=secretref:registration-code"

      - name: Azure Logout
        run: az logout
        if: always()

  deploy-production:
    name: Deploy to Production
    needs: [deploy-testing]
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://flowie-api-prd.livelywave-420a42c9.westeurope.azurecontainerapps.io

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install EF Core tools
        run: dotnet tool install --global dotnet-ef --version 9.0.9 || dotnet tool update --global dotnet-ef --version 9.0.9

      - name: Restore dependencies
        run: dotnet restore backend/Flowie.Api/Flowie.Api.csproj

      - name: Build for migrations
        run: dotnet build backend/Flowie.Api/Flowie.Api.csproj --no-restore

      - name: Run database migrations
        run: dotnet ef database update --project backend/Flowie.Api/Flowie.Api.csproj --connection "${{ secrets.AZURE_SQL_CONNECTION_STRING_PRODUCTION }}" --no-build --verbose

      - name: Log in to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_LOGIN_SERVER_PRODUCTION }}
          username: ${{ secrets.ACR_USERNAME_PRODUCTION }}
          password: ${{ secrets.ACR_PASSWORD_PRODUCTION }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Flowie.Api/Dockerfile
          push: true
          tags: |
            ${{ secrets.ACR_LOGIN_SERVER_PRODUCTION }}/flowie-api:latest
            ${{ secrets.ACR_LOGIN_SERVER_PRODUCTION }}/flowie-api:${{ github.sha }}

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Register Microsoft.App provider
        run: az provider register -n Microsoft.App --wait

      - name: Deploy to Azure Container Apps
        run: |
          az containerapp registry set \
            --name ${{ secrets.CONTAINER_APP_NAME_PRODUCTION }} \
            --resource-group ${{ secrets.CONTAINER_APP_RESOURCE_GROUP_PRODUCTION }} \
            --server ${{ secrets.ACR_LOGIN_SERVER_PRODUCTION }} \
            --username ${{ secrets.ACR_USERNAME_PRODUCTION }} \
            --password ${{ secrets.ACR_PASSWORD_PRODUCTION }}

          az containerapp secret set \
            --name ${{ secrets.CONTAINER_APP_NAME_PRODUCTION }} \
            --resource-group ${{ secrets.CONTAINER_APP_RESOURCE_GROUP_PRODUCTION }} \
            --secrets \
              flowie-db-connection="${{ secrets.AZURE_SQL_CONNECTION_STRING_PRODUCTION }}" \
              jwt-secret-key="${{ secrets.JWT_SECRET_KEY_PRODUCTION }}" \
              registration-code="${{ secrets.REGISTRATION_CODE_PRODUCTION }}"

          az containerapp update \
            --name ${{ secrets.CONTAINER_APP_NAME_PRODUCTION }} \
            --resource-group ${{ secrets.CONTAINER_APP_RESOURCE_GROUP_PRODUCTION }} \
            --image ${{ secrets.ACR_LOGIN_SERVER_PRODUCTION }}/flowie-api:${{ github.sha }} \
            --set-env-vars \
              "ASPNETCORE_ENVIRONMENT=Production" \
              "ConnectionStrings__FlowieDb=secretref:flowie-db-connection" \
              "JwtSettings__SecretKey=secretref:jwt-secret-key" \
              "Registration__Code=secretref:registration-code"

      - name: Azure Logout
        run: az logout
        if: always()